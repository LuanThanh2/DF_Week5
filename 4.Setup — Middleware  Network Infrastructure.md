# Pre-Lab Setup — Middleware / Network Infrastructure (DHCP, Firewall, Proxy/Gateway)

This guide explains how instructors can set up and collect **middleware and infrastructure logs** for use in the Week 1 Network Forensics lab. These logs simulate how DHCP servers, firewalls, and gateways record events that can be correlated with host and packet evidence.

---

## 1. DHCP Server Logs

### Environment Setup

- Use an Ubuntu/Debian VM.
- Install ISC DHCP server:

  ```bash
  sudo apt update && sudo apt install -y isc-dhcp-server
  ```

### Configuration

- Edit `/etc/dhcp/dhcpd.conf` to include a sample subnet:

  ```
  subnet 10.0.5.0 netmask 255.255.255.0 {
    range 10.0.5.20 10.0.5.50;
    option routers 10.0.5.1;
    option domain-name-servers 8.8.8.8;
  }
  ```

### Generate Activity

- Start/renew DHCP leases on client VMs:

  ```bash
  sudo dhclient -v eth0
  ```

- Repeat with multiple clients to create multiple leases.

### Collect Logs

- Logs are stored in `/var/log/syslog` or `/var/log/dhcpd.log`.
- Extract relevant lines:

  ```bash
  grep DHCP /var/log/syslog > ~/lab_logs/dhcp.log
  ```

- Hash:

  ```bash
  sha256sum ~/lab_logs/dhcp.log
  ```

**Deliverable:** `dhcp.log`

---

## 2. Firewall Logs (UFW/iptables Example)

### Environment Setup

- Use Ubuntu with UFW enabled:

  ```bash
  sudo apt install -y ufw
  sudo ufw enable
  ```

### Add Rules to Simulate Activity

```bash
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw deny 12345/tcp
```

- Generate traffic (use curl, netcat):

  ```bash
  curl http://example.com
  nc -zv target.ip 12345
  ```

### Collect Logs

- Logs stored in `/var/log/ufw.log`.
- Copy to lab folder:

  ```bash
  sudo cp /var/log/ufw.log ~/lab_logs/fw.log
  ```

- Hash:

  ```bash
  sha256sum ~/lab_logs/fw.log
  ```

**Deliverable:** `fw.log`

---

## 3. Proxy/Gateway Logs (Squid as Transparent Proxy)

If not already using Squid (from Application Layer setup), configure as a gateway node.

### Install Squid

```bash
sudo apt update && sudo apt install -y squid
```

### Configure Transparent Proxy

Edit `/etc/squid/squid.conf`:

```conf
http_port 3128 intercept
access_log /var/log/squid/access.log squid
```

### Generate Traffic

- Redirect client VM traffic through Squid (using iptables DNAT/REDIRECT).
- Simulate browsing:

  ```bash
  curl http://example.org
  curl -A "SuspiciousAgent/2.0" http://malicious.example.com
  ```

### Collect Logs

```bash
sudo cp /var/log/squid/access.log ~/lab_logs/proxy.log
sha256sum ~/lab_logs/proxy.log
```

**Deliverable:** `proxy.log`

---

## 4. Packaging for Students

Organize evidence bundle:

```
infra-logs/
  dhcp.log
  fw.log
  proxy.log
```

Include `hash_manifest.txt` with SHA-256 checksums.

---

## Verification Checklist (Instructor)

- [ ] DHCP server produced multiple lease assignments, exported to `dhcp.log`.
- [ ] Firewall rules triggered both allow and deny logs, exported to `fw.log`.
- [ ] Proxy captured benign + suspicious traffic, exported to `proxy.log`.
- [ ] All logs hashed and packaged into `infra-logs/`.

---

✅ With these middleware logs prepared, students will use them in **Task 4 (DHCP/NAT Attribution & Middleware Correlation)** of the Week 1 lab.
